/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.1
 *  Project: http://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/topic","dojo/query","dojo/dom-construct","dojo/dom-attr","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_Contained","dijit/MenuItem","dijit/MenuSeparator","./_Control","./_DynamicSublayer","./_DynamicFolder","./../plugins/legendUtil","dojo/i18n!./../nls/resource"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=a([j,k,l,o],{_layerType:"overlay",_esriLayerType:"dynamic",_hasSublayers:!1,_visLayersHandler:null,constructor:function(){this._sublayerControls=[]},_layerTypePreInit:function(){this.layer.layerInfos.length>1&&this.controlOptions.sublayers&&(this._hasSublayers=!0,this._visLayersHandler=d.after(this.layer,"setVisibleLayers",b.hitch(this,"_onSetVisibleLayers"),!0))},_layerTypeInit:function(){var a=r.isLegend(this.controlOptions.noLegend,this.controller.noLegend);a&&this.controlOptions.sublayers===!0?(this._expandClick(),this._createSublayers(this.layer),d.after(this,"_createSublayers",b.hitch(this,r.dynamicSublayerLegend(this.layer,this.expandNode)))):this.controlOptions.sublayers===!1&&a?(this._expandClick(),r.layerLegend(this.layer,this.expandNode)):this.controlOptions.sublayers!==!0||a?this._expandRemove():(this._expandClick(),d.after(this,"_createSublayers",b.hitch(this,"_removeSublayerLegends")),this._createSublayers(this.layer))},_dynamicToggleMenuItems:function(a){this._hasSublayers&&this.controlOptions.allSublayerToggles!==!1&&(a.addChild(new m({label:s.dynamicSublayersOn,onClick:b.hitch(this,"_toggleAllSublayers",!0)})),a.addChild(new m({label:s.dynamicSublayersOff,onClick:b.hitch(this,"_toggleAllSublayers",!1)})),a.addChild(new n)),this._hasSublayers||c.forEach(this.controlOptions.menu,b.hitch(this,"_addMenuItem",a))},_addMenuItem:function(a,c){var d=new m(c);d.set("onClick",b.hitch(this,function(){e.publish("layerControl/"+c.topic,{layer:this.layer,subLayer:this.layer.layerInfos[0],iconNode:this.iconNode,menuItem:d})})),a.addChild(d)},_toggleAllSublayers:function(a){c.forEach(this._sublayerControls,function(b){b._setSublayerCheckbox(a)}),this._setVisibleLayers()},_createSublayers:function(a){if(a.layerInfos.length>1){var d=c.map(a.layerInfos,function(a){return a.id});c.forEach(a.layerInfos,b.hitch(this,function(e){var f=c.filter(this.controlOptions.subLayerInfos,function(a){return a.id===e.id}).shift();b.mixin(e,f);var h,j=e.parentLayerId,k=e.subLayerIds,l=a.id+"-"+e.id+"-sublayer-control";j===-1||d.indexOf(j)===-1?null===k?(h=new p({id:l,control:this,sublayerInfo:e,icons:this.icons}),g.place(h.domNode,this.expandNode,"last")):null!==k&&(h=new q({id:l,control:this,sublayerInfo:e,icons:this.icons}),g.place(h.domNode,this.expandNode,"last")):j!==-1&&null!==k?(h=new q({id:l,control:this,sublayerInfo:e,icons:this.icons}),g.place(h.domNode,i.byId(a.id+"-"+e.parentLayerId+"-sublayer-control").expandNode,"last")):j!==-1&&null===k&&(h=new p({id:l,control:this,sublayerInfo:e,icons:this.icons}),g.place(h.domNode,i.byId(a.id+"-"+e.parentLayerId+"-sublayer-control").expandNode,"last")),h.startup(),this._sublayerControls.push(h)}))}},_removeSublayerLegends:function(){c.forEach(this._sublayerControls,function(a){a.sublayerInfo.subLayerIds||g.destroy(a.expandClickNode)})},_setVisibleLayers:function(){this._visLayersHandler.remove();var a=this.layer,g=[];c.forEach(f("."+a.id+"-layerControlSublayerCheck"),function(a){"checked"===h.get(a,"data-checked")&&g.push(parseInt(h.get(a,"data-sublayer-id"),10))}),c.forEach(a.layerInfos,function(a){null!==a.subLayerIds&&c.indexOf(g,a.id)===-1?c.forEach(a.subLayerIds,function(a){c.indexOf(g,a)!==-1&&g.splice(c.indexOf(g,a),1)}):null!==a.subLayerIds&&c.indexOf(g,a.id)!==-1&&g.splice(c.indexOf(g,a.id),1)}),g.length||g.push(-1),a.setVisibleLayers(g),a.refresh(),e.publish("layerControl/setVisibleLayers",{id:a.id,visibleLayers:g}),this._visLayersHandler=d.after(this.layer,"setVisibleLayers",b.hitch(this,"_onSetVisibleLayers"),!0)},_onSetVisibleLayers:function(a){var b=[];c.forEach(this.layer.layerInfos,function(d){c.indexOf(a,d.id)!==-1&&b.push(d.id),d.parentLayerId!==-1&&c.indexOf(b,d.parentLayerId)===-1&&b.push(d.parentLayerId)}),c.forEach(this._sublayerControls,function(a){c.indexOf(b,a.sublayerInfo.id)!==-1?a._setSublayerCheckbox(!0):a._setSublayerCheckbox(!1)})}});return t});
//# sourceMappingURL=Dynamic.js.map