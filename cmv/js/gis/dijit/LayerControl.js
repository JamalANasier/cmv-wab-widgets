/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.1
 *  Project: http://cmv.io/
 */

define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/topic","dojo/dom-attr","dojo/dom-construct","dijit/_WidgetBase","dijit/_Container","dijit/layout/ContentPane","dijit/form/Button","esri/tasks/ProjectParameters","esri/config","require","xstyle/css!./LayerControl/css/LayerControl.css"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=a([g,h],{map:null,layerInfos:[],icons:{expand:"fa-plus-square-o",collapse:"fa-minus-square-o",checked:"fa-check-square-o",unchecked:"fa-square-o",update:"fa-refresh",menu:"fa-bars",folder:"fa-folder-o",folderOpen:"fa-folder-open-o"},separated:!1,overlayReorder:!1,overlayLabel:!1,vectorReorder:!1,vectorLabel:!1,noMenu:null,noLegend:null,noZoom:null,noTransparency:null,subLayerMenu:{},swipe:null,swiperButtonStyle:"position:absolute;top:20px;left:120px;z-index:50;",baseClass:"layerControlDijit",_vectorContainer:null,_overlayContainer:null,_swiper:null,_swipeLayerToggleHandle:null,_controls:{dynamic:"./LayerControl/controls/Dynamic",feature:"./LayerControl/controls/Feature",image:"./LayerControl/controls/Image",tiled:"./LayerControl/controls/Tiled",csv:"./LayerControl/controls/CSV",georss:"./LayerControl/controls/GeoRSS",wms:"./LayerControl/controls/WMS",wfs:"./LayerControl/controls/WFS",kml:"./LayerControl/controls/KML",vectortile:"./LayerControl/controls/VectorTile",webtiled:"./LayerControl/controls/WebTiled",imagevector:"./LayerControl/controls/ImageVector",raster:"./LayerControl/controls/Raster",stream:"./LayerControl/controls/Stream"},constructor:function(a){return a=a||{},a.map?void(this._controls=c.mixin(this._controls,a.controls||{})):void d.publish("viewer/handleError",{source:"LayerControl",error:"map option is required"})},postCreate:function(){if(this.inherited(arguments),this.separated){var b=a([g,h]);this.vectorLabel!==!1&&this.addChild(new i({className:"vectorLabelContainer",content:this.vectorLabel},f.create("div")),"first"),this._vectorContainer=new b({className:"vectorLayerContainer"},f.create("div")),this.addChild(this._vectorContainer,"last"),this.overlayLabel!==!1&&this.addChild(new i({className:"overlayLabelContainer",content:this.overlayLabel},f.create("div")),"last"),this._overlayContainer=new b({className:"overlayLayerContainer"},f.create("div")),this.addChild(this._overlayContainer,"last")}else this.overlayReorder=!1,this.vectorReorder=!1;this._addLayerControls(this.layerInfos),this._subscribeToTopics()},_subscribeToTopics:function(){this._removeLayerControlsHandler=d.subscribe("layerControl/removeLayerControls",c.hitch(this,function(a){this._removeLayerControls(a)})),this._addLayerControlsHandler=d.subscribe("layerControl/addLayerControls",c.hitch(this,function(a){this._addLayerControls(a)}))},_addLayerControls:function(a){var e=[];b.forEach(a,function(a){var b=a.controlOptions;if(!b||b.exclude!==!0){var c=this._controls[a.type];c?e.push(c):d.publish("viewer/handleError",{source:"LayerControl",error:'the layer type "'+a.type+'" is not supported'})}},this),m(e,c.hitch(this,function(){b.forEach(a,function(a){var b=a.controlOptions;if(!b||b.exclude!==!0){var d=this._controls[a.type];d&&m([d],c.hitch(this,"_addControl",a))}},this),this._checkReorder()}))},_removeLayerControls:function(a){function d(b){return a.reduce(function(a,c){return c===b.layer||a},!1)}var e=this._overlayContainer.getChildren().filter(function(a){return d(a)}).concat(this._vectorContainer.getChildren().filter(function(a){return d(a)})).concat(this.getChildren().filter(function(a){return d(a)}));b.forEach(e,c.hitch(this,function(a){this.separated?"overlay"===a._layerType?this._overlayContainer.removeChild(a):this._vectorContainer.removeChild(a):this.removeChild(a),a.destroy()}))},_addControl:function(a,b){var d="string"==typeof a.layer?this.map.getLayer(a.layer):a.layer;!a.controlOptions||"dynamic"!==a.type&&"feature"!==a.type||(d.loaded?this._applyLayerControlOptions(a.controlOptions,d):d.on("load",c.hitch(this,"_applyLayerControlOptions",a.controlOptions)));var e=new b({controller:this,layer:d,layerTitle:a.title,controlOptions:c.mixin({noLegend:null,noZoom:null,noTransparency:null,swipe:null,expanded:!1,sublayers:!0,menu:this.subLayerMenu[a.type]},a.controlOptions)});e.startup();var f=a.position||0;this.separated?"overlay"===e._layerType?this._overlayContainer.addChild(e,f):this._vectorContainer.addChild(e,f):this.addChild(e,f)},_applyLayerControlOptions:function(a,c){if("undefined"!=typeof a.includeUnspecifiedLayers||"undefined"!=typeof a.subLayerInfos||"undefined"!=typeof a.excludedLayers){var d=[];if(!a.includeUnspecifiedLayers&&a.subLayerInfos&&0!==a.subLayerInfos.length){var e=b.map(a.subLayerInfos,function(a){return a.id});b.forEach(c.layerInfos,function(a){b.indexOf(e,a.id)!==-1&&d.push(a)})}else if(a.excludedLayers)b.forEach(c.layerInfos,function(c){b.indexOf(a.excludedLayers,c.id)===-1&&d.push(c)});else if(a.subLayerInfos)return this._mixinLayerInfos(c.layerInfos,a.subLayerInfos),void this._setSublayerVisibilities(c);a.subLayerInfos&&this._mixinLayerInfos(d,a.subLayerInfos),c.layerInfos=d,this._setSublayerVisibilities(c)}},_setSublayerVisibilities:function(a){var c=b.map(b.filter(a.layerInfos,function(a){return a.defaultVisibility}),function(a){return a.id});a.setVisibleLayers(c)},_mixinLayerInfos:function(a,d){d&&0!==d.length&&(b.forEach(d,function(a){"undefined"==typeof a.defaultVisibility&&(a.defaultVisibility=!0)}),b.forEach(a,function(a){var e=b.filter(d,function(b){return b.id===a.id}).shift();e&&c.mixin(a,e)}))},_moveUp:function(a){var c,d=a.layer.id,e=a.domNode;"overlay"===a._layerType?a.getPreviousSibling()&&(c=b.indexOf(this.map.layerIds,d),this.map.reorderLayer(d,c+1),this._overlayContainer.containerNode.insertBefore(e,e.previousSibling),this._checkReorder()):"vector"===a._layerType&&a.getPreviousSibling()&&(c=b.indexOf(this.map.graphicsLayerIds,d),this.map.reorderLayer(d,c+1),this._vectorContainer.containerNode.insertBefore(e,e.previousSibling),this._checkReorder())},_moveDown:function(a){var c,d=a.layer.id,e=a.domNode;"overlay"===a._layerType?a.getNextSibling()&&(c=b.indexOf(this.map.layerIds,d),this.map.reorderLayer(d,c-1),this._overlayContainer.containerNode.insertBefore(e,e.nextSibling.nextSibling),this._checkReorder()):"vector"===a._layerType&&a.getNextSibling()&&(c=b.indexOf(this.map.graphicsLayerIds,d),this.map.reorderLayer(d,c-1),this._vectorContainer.containerNode.insertBefore(e,e.nextSibling.nextSibling),this._checkReorder())},_checkReorder:function(){this.separated&&(this.vectorReorder&&b.forEach(this._vectorContainer.getChildren(),function(a){a._reorderUp&&(a.getPreviousSibling()?a._reorderUp.set("disabled",!1):a._reorderUp.set("disabled",!0)),a._reorderDown&&(a.getNextSibling()?a._reorderDown.set("disabled",!1):a._reorderDown.set("disabled",!0))},this),this.overlayReorder&&b.forEach(this._overlayContainer.getChildren(),function(a){a._reorderUp&&(a.getPreviousSibling()?a._reorderUp.set("disabled",!1):a._reorderUp.set("disabled",!0)),a._reorderDown&&(a.getNextSibling()?a._reorderDown.set("disabled",!1):a._reorderDown.set("disabled",!0))},this))},_zoomToLayer:function(a){if("esri.layers.KMLLayer"!==a.declaredClass){var b=this.map;a.spatialReference===b.spatialReference?b.setExtent(a.fullExtent,!0):l.defaults.geometryService?l.defaults.geometryService.project(c.mixin(new k,{geometries:[a.fullExtent],outSR:b.spatialReference}),function(a){b.setExtent(a[0],!0)},function(a){d.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:a})}):d.publish("viewer/handleError",{source:"LayerControl._zoomToLayer",error:"esriConfig.defaults.geometryService is not set"})}},_swipeLayer:function(a,b){a&&a.visible&&(this._swiper?(this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),this._swiper.set("layers",[a]),this._swiper.set("type",b),this._swiper.enable(),e.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)):m(["esri/dijit/LayerSwipe"],c.hitch(this,function(d){this._swiper=new d({type:b||"vertical",map:this.map,layers:[a]},f.create("div",{},this.map.id,"first")),this._swiper.startup(),this._swiper.disableBtn=new j({label:"Exit Layer Swipe",onClick:c.hitch(this,"_swipeDisable")},f.create("div",{},this.map.id)),e.set(this._swiper.disableBtn.domNode,"style",this.swiperButtonStyle)})),this._swipeLayerToggleHandle=d.subscribe("layerControl/layerToggle",c.hitch(this,function(b){b.id!==a.id||b.visible||this._swipeDisable()})))},_swipeDisable:function(){this._swiper.disable(),this._swipeLayerToggleHandle&&this._swipeLayerToggleHandle.remove(),e.set(this._swiper.disableBtn.domNode,"style","display:none;")},showAllLayers:function(){this.separated?(b.forEach(this._vectorContainer.getChildren(),function(a){a.layer.show()}),b.forEach(this._overlayContainer.getChildren(),function(a){a.layer.show()})):b.forEach(this.getChildren(),function(a){a.layer.show()})},hideAllLayers:function(){this.separated?(b.forEach(this._vectorContainer.getChildren(),function(a){a.layer.hide()}),b.forEach(this._overlayContainer.getChildren(),function(a){a.layer.hide()})):b.forEach(this.getChildren(),function(a){a.layer.hide()})}});return n});
//# sourceMappingURL=LayerControl.js.map