{"version":3,"sources":["_MapMixin.js"],"names":["define","declare","lang","on","dom","array","Deferred","Map","initMapAsync","returnDeferred","returnWarnings","this","_createMap","then","hitch","mapDeferred","container","byId","config","layout","map","webMapId","_initWebMap","webMapOptions","push","resolve","mapOptions","_createMapResult","basemap","_initLayers","operationalLayers","length","once","_onLayersAddResult","lyrsResult","forEach","layers","addedLayer","success","error","layerTypes","csv","dataadapter","dynamic","feature","georss","image","imagevector","kml","label","mapimage","osm","raster","stream","tiled","vectortile","webtiled","wfs","wms","wmts","mixin","modules","layer","type","require","addLayers","_initLayer","Layer","l","url","options","unshift","excludeLayerFromLegend","legendLayerInfos","exclude","configuredLayerInfo","layerInfo","title","layerControlLayerInfos","controlOptions","featureLayer","editorLayerInfos","idOptions","identifyLayerInfos","initMapComplete","warnings","handleError","source","join","createWidgets","evt","pnt","target","extent","getCenter","setTimeout","centerAt","createPanes","initMapError","err","resizeMap","resize","getMapHeight","height"],"mappings":"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","file":"_MapMixin.js","sourcesContent":["define([\r\n    'dojo/_base/declare',\r\n    'dojo/_base/lang',\r\n    'dojo/on',\r\n    'dojo/dom',\r\n    'dojo/_base/array',\r\n    'dojo/Deferred',\r\n\r\n    'esri/map',\r\n\r\n    'esri/IdentityManager'\r\n\r\n], function (\r\n    declare,\r\n    lang,\r\n    on,\r\n    dom,\r\n    array,\r\n    Deferred,\r\n\r\n    Map\r\n) {\r\n\r\n    return declare(null, {\r\n\r\n        initMapAsync: function () {\r\n            var returnDeferred = new Deferred();\r\n            var returnWarnings = [];\r\n\r\n            this._createMap(returnWarnings).then(\r\n                lang.hitch(this, '_createMapResult', returnDeferred, returnWarnings)\r\n            );\r\n            return returnDeferred;\r\n        },\r\n\r\n        _createMap: function (returnWarnings) {\r\n            var mapDeferred = new Deferred(),\r\n                container = dom.byId(this.config.layout.map) || 'mapCenter';\r\n\r\n            if (this.config.webMapId) {\r\n                if (this._initWebMap) {\r\n                    mapDeferred = this._initWebMap(this.config.webMapId, container, this.config.webMapOptions);\r\n                } else {\r\n                    returnWarnings.push('The \"_WebMapMixin\" Controller Mixin is required to use a webmap');\r\n                    mapDeferred.resolve(returnWarnings);\r\n                }\r\n            } else {\r\n                this.map = new Map(container, this.config.mapOptions);\r\n                mapDeferred.resolve(returnWarnings);\r\n            }\r\n            return mapDeferred;\r\n        },\r\n\r\n        _createMapResult: function (returnDeferred, returnWarnings) {\r\n            if (this.map) {\r\n                if (!this.config.webMapId && this.config.mapOptions && this.config.mapOptions.basemap) {\r\n                    this.map.on('load', lang.hitch(this, '_initLayers', returnWarnings));\r\n                } else {\r\n                    this._initLayers(returnWarnings);\r\n                }\r\n\r\n                if (this.config.operationalLayers && this.config.operationalLayers.length > 0) {\r\n                    on.once(this.map, 'layers-add-result', lang.hitch(this, '_onLayersAddResult', returnDeferred, returnWarnings));\r\n                } else {\r\n                    returnDeferred.resolve(returnWarnings);\r\n                }\r\n            } else {\r\n                returnDeferred.resolve(returnWarnings);\r\n            }\r\n            return returnDeferred;\r\n        },\r\n\r\n        _onLayersAddResult: function (returnDeferred, returnWarnings, lyrsResult) {\r\n            array.forEach(lyrsResult.layers, function (addedLayer) {\r\n                if (addedLayer.success !== true) {\r\n                    returnWarnings.push(addedLayer.error);\r\n                }\r\n            }, this);\r\n            returnDeferred.resolve(returnWarnings);\r\n        },\r\n\r\n        _initLayers: function (returnWarnings) {\r\n            this.layers = [];\r\n            var layerTypes = {\r\n                csv: 'esri/layers/CSVLayer',\r\n                dataadapter: 'esri/layers/DataAdapterFeatureLayer', //untested\r\n                dynamic: 'esri/layers/ArcGISDynamicMapServiceLayer',\r\n                feature: 'esri/layers/FeatureLayer',\r\n                georss: 'esri/layers/GeoRSSLayer',\r\n                image: 'esri/layers/ArcGISImageServiceLayer',\r\n                imagevector: 'esri/layers/ArcGISImageServiceVectorLayer',\r\n                kml: 'esri/layers/KMLLayer',\r\n                label: 'esri/layers/LabelLayer', //untested\r\n                mapimage: 'esri/layers/MapImageLayer', //untested\r\n                osm: 'esri/layers/OpenStreetMapLayer',\r\n                raster: 'esri/layers/RasterLayer',\r\n                stream: 'esri/layers/StreamLayer',\r\n                tiled: 'esri/layers/ArcGISTiledMapServiceLayer',\r\n                vectortile: 'esri/layers/VectorTileLayer',\r\n                webtiled: 'esri/layers/WebTiledLayer',\r\n                wfs: 'esri/layers/WFSLayer',\r\n                wms: 'esri/layers/WMSLayer',\r\n                wmts: 'esri/layers/WMTSLayer' //untested\r\n            };\r\n            // add any user-defined layer types such as https://github.com/Esri/geojson-layer-js\r\n            layerTypes = lang.mixin(layerTypes, this.config.layerTypes || {});\r\n            // loading all the required modules first ensures the layer order is maintained\r\n            var modules = [];\r\n            array.forEach(this.config.operationalLayers, function (layer) {\r\n                var type = layerTypes[layer.type];\r\n                if (type) {\r\n                    modules.push(type);\r\n                } else {\r\n                    returnWarnings.push('Layer type \"' + layer.type + '\" is not supported: ');\r\n                }\r\n            }, this);\r\n\r\n            require(modules, lang.hitch(this, function () {\r\n                array.forEach(this.config.operationalLayers, function (layer) {\r\n                    var type = layerTypes[layer.type];\r\n                    if (type) {\r\n                        require([type], lang.hitch(this, '_initLayer', layer));\r\n                    }\r\n                }, this);\r\n                this.map.addLayers(this.layers);\r\n            }));\r\n        },\r\n\r\n        _initLayer: function (layer, Layer) {\r\n            var l;\r\n            if (layer.url) {\r\n                l = new Layer(layer.url, layer.options);\r\n            } else {\r\n                l = new Layer(layer.options);\r\n            }\r\n            this.layers.unshift(l); //unshift instead of push to keep layer ordering on map intact\r\n\r\n            //Legend LayerInfos array\r\n            var excludeLayerFromLegend = false;\r\n            if (typeof layer.legendLayerInfos !== 'undefined' && typeof layer.legendLayerInfos.exclude !== 'undefined') {\r\n                excludeLayerFromLegend = layer.legendLayerInfos.exclude;\r\n            }\r\n            if (!excludeLayerFromLegend) {\r\n                var configuredLayerInfo = {};\r\n                if (typeof layer.legendLayerInfos !== 'undefined' && typeof layer.legendLayerInfos.layerInfo !== 'undefined') {\r\n                    configuredLayerInfo = layer.legendLayerInfos.layerInfo;\r\n                }\r\n                var layerInfo = lang.mixin({\r\n                    layer: l,\r\n                    title: layer.title || null\r\n                }, configuredLayerInfo);\r\n                this.legendLayerInfos.unshift(layerInfo); //unshift instead of push to keep layer ordering in legend intact\r\n            }\r\n\r\n            //LayerControl LayerInfos array\r\n            this.layerControlLayerInfos.unshift({ //unshift instead of push to keep layer ordering in LayerControl intact\r\n                layer: l,\r\n                type: layer.type,\r\n                title: layer.title,\r\n                controlOptions: layer.layerControlLayerInfos\r\n            });\r\n\r\n            if (layer.type === 'feature') {\r\n                var options = {\r\n                    featureLayer: l\r\n                };\r\n                if (layer.editorLayerInfos) {\r\n                    lang.mixin(options, layer.editorLayerInfos);\r\n                }\r\n                if (options.exclude !== true) {\r\n                    this.editorLayerInfos.push(options);\r\n                }\r\n            }\r\n\r\n            if (layer.type === 'dynamic' || layer.type === 'feature') {\r\n                var idOptions = {\r\n                    layer: l,\r\n                    title: layer.title\r\n                };\r\n                if (layer.identifyLayerInfos) {\r\n                    lang.mixin(idOptions, layer.identifyLayerInfos);\r\n                }\r\n                if (idOptions.exclude !== true) {\r\n                    this.identifyLayerInfos.push(idOptions);\r\n                }\r\n            }\r\n        },\r\n        initMapComplete: function (warnings) {\r\n            if (warnings && warnings.length > 0) {\r\n                this.handleError({\r\n                    source: 'Controller',\r\n                    error: warnings.join(', ')\r\n                });\r\n            }\r\n\r\n            if (this.map) {\r\n                // in _WidgetsMixin\r\n                this.createWidgets(['map', 'layer']);\r\n\r\n                this.map.on('resize', function (evt) {\r\n                    var pnt = evt.target.extent.getCenter();\r\n                    setTimeout(function () {\r\n                        evt.target.centerAt(pnt);\r\n                    }, 100);\r\n                });\r\n\r\n                // in _LayoutsMixin\r\n                this.createPanes();\r\n\r\n                // in _WidgetsMixin\r\n                this.createWidgets();\r\n            }\r\n\r\n        },\r\n\r\n        initMapError: function (err) {\r\n            this.handleError({\r\n                source: 'Controller',\r\n                error: err\r\n            });\r\n        },\r\n\r\n        resizeMap: function () {\r\n            if (this.map) {\r\n                this.map.resize();\r\n            }\r\n        },\r\n\r\n        getMapHeight: function () {\r\n            if (this.map) {\r\n                return this.map.height;\r\n            } else {\r\n                return 0;\r\n            }\r\n        }\r\n    });\r\n});"]}