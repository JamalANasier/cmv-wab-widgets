/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.1
 *  Project: http://cmv.io/
 */

define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojo/_base/lang","dojo/aspect","dojo/topic","esri/layers/GraphicsLayer","esri/graphic","esri/renderers/SimpleRenderer","dojo/text!./StreetView/templates/StreetView.html","esri/symbols/PictureMarkerSymbol","dojo/dom-style","dojo/dom-geometry","esri/geometry/Point","esri/SpatialReference","dijit/MenuItem","proj4js/proj4","dojo/i18n!./StreetView/nls/resource","gis/plugins/Google","dijit/form/ToggleButton","xstyle/css!./StreetView/css/StreetView.css"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){var u;return a([b,c,d],{widgetsInTemplate:!0,templateString:k,i18n:s,mapClickMode:null,panoOptions:null,proj4BaseURL:"https://epsg.io/",proj4Catalog:"EPSG",proj4CustomURL:null,postCreate:function(){this.inherited(arguments),t.load(e.hitch(this,function(a){u=a,this.panoOptions={addressControlOptions:{position:u.maps.ControlPosition.TOP_RIGHT},linksControl:!1,panControl:!1,zoomControlOptions:{style:u.maps.ZoomControlStyle.SMALL},enableCloseButton:!1},this.createGraphicsLayer(),this.map.on("click",e.hitch(this,"getStreetView")),this.own(g.subscribe("mapClickMode/currentSet",e.hitch(this,"setMapClickMode"))),this.parentWidget&&(this.parentWidget.toggleable&&this.own(f.after(this.parentWidget,"toggle",e.hitch(this,function(){this.onLayoutChange(this.parentWidget.open)}))),this.own(f.after(this.parentWidget,"resize",e.hitch(this,"resize"))),this.own(g.subscribe(this.parentWidget.id+"/resize/resize",e.hitch(this,"resize")))),window.proj4||(window.proj4=r),this.mapRightClickMenu&&this.addRightClickMenu()}))},createGraphicsLayer:function(){this.pointSymbol=new l(require.toUrl("gis/dijit/StreetView/images/blueArrow.png"),30,30),this.pointGraphics=new h({id:"streetview_graphics",title:"Street View"}),this.pointRenderer=new j(this.pointSymbol),this.pointRenderer.label="Street View",this.pointRenderer.description="Street View",this.pointGraphics.setRenderer(this.pointRenderer),this.map.addLayer(this.pointGraphics)},addRightClickMenu:function(){this.map.on("MouseDown",e.hitch(this,function(a){this.mapRightClickPoint=a.mapPoint})),this.mapRightClickMenu.addChild(new q({label:this.i18n.rightClickMenuItem.label,onClick:e.hitch(this,"streetViewFromMapRightClick")}))},onOpen:function(){this.pointGraphics.show(),this.panorama&&this.panoramaService||(this.panorama=new u.maps.StreetViewPanorama(this.panoNode,this.panoOptions),this.panoramaService=new u.maps.StreetViewService)},onClose:function(){this.pointGraphics.hide(),"streetview"===this.mapClickMode&&this.connectMapClick()},onLayoutChange:function(a){a?this.onOpen():this.onClose()},placePoint:function(){this.streetViewButtonDijit.get("checked")?this.disconnectMapClick():this.connectMapClick()},disconnectMapClick:function(){this.streetViewButtonDijit.set("checked",!0),this.map.setMapCursor("crosshair"),g.publish("mapClickMode/setCurrent","streetview")},connectMapClick:function(){this.streetViewButtonDijit.set("checked",!1),this.map.setMapCursor("auto"),g.publish("mapClickMode/setDefault")},clearGraphics:function(){this.pointGraphics.clear(),m.set(this.noStreetViewResults,"display","block")},enableStreetViewClick:function(){this.disconnectMapClick()},disableStreetViewClick:function(){this.connectMapClick()},getStreetView:function(a,b){if("streetview"===this.mapClickMode||b){var c=a.mapPoint;if(!c)return;this.parentWidget&&!this.parentWidget.open&&this.parentWidget.toggle();var d=null,f=c.spatialReference.wkid;102100===f&&(f=3857);var g=this.proj4Catalog+":"+String(f);if(!r.defs[g]){var h=this.proj4CustomURL||this.proj4BaseURL+String(f)+".js";return void require([h],e.hitch(this,"getStreetView",a,!0))}var i=r(r.defs[g]).inverse([c.x,c.y]);i&&(d={x:i[0],y:i[1]}),m.set(this.streetViewInstructions,"display","none"),d?(m.set(this.noStreetViewResults,"display","none"),this.getPanoramaLocation(d)):(this.setPanoPlace=null,this.clearGraphics(),m.set(this.noStreetViewResults,"display","block"))}},getPanoramaLocation:function(a){var b=new u.maps.LatLng(a.y,a.x);this.panoramaService.getPanoramaByLocation(b,50,e.hitch(this,"getPanoramaByLocationComplete",a)),u.maps.event.addListener(this.panorama,"position_changed",e.hitch(this,"setPlaceMarkerPosition")),u.maps.event.addListener(this.panorama,"pov_changed",e.hitch(this,"setPlaceMarkerRotation"))},getPanoramaByLocationComplete:function(a,b,c){if("OK"===c){this.disableStreetViewClick();var d=new u.maps.LatLng(a.y,a.x);this.setPanoPlace=d,this.firstSet=!0,this.panorama.setPosition(d)}else"ZERO_RESULTS"===c?(this.setPanoPlace=null,this.clearGraphics(),this.connectMapClick(),m.set(this.noStreetViewResults,"display","block")):(this.setPanoPlace=null,this.clearGraphics(),g.publish("viewer/handleError",{source:"StreetView",error:"Unknown."}))},resize:function(a){a&&a.h&&n.setContentSize(this.containerNode,{h:a.h-2}),this.panorama&&u.maps.event.trigger(this.panorama,"resize")},setPlaceMarkerPosition:function(){this.placeMarker&&0!==this.pointGraphics.graphics.length||(this.placeMarker=new i,this.pointGraphics.add(this.placeMarker));var a=this.panorama.getPosition(),b=a.lat(),c=a.lng();if(!isNaN(b)&&!isNaN(c)){var d=null,f=this.map.spatialReference.wkid;102100===f&&(f=3857);var g=this.proj4Catalog+":"+String(f);if(!r.defs[g]){var h=this.proj4CustomURL||this.proj4BaseURL+String(f)+".js";return void require([h],e.hitch(this,"setPlaceMarkerPosition"))}if(d=r(r.defs[g]).forward([c,b])){var j=new o(d,new p({wkid:f}));if(this.placeMarker.setGeometry(j),this.setPanoPlace&&!this.firstSet){var k=u.maps.geometry.spherical.computeHeading(a,this.setPanoPlace);this.panorama.setPov({heading:k,pitch:0}),setTimeout(e.hitch(this,function(){this.setPanoPlace=null}),1e3)}else this.firstSet=!1}}},setPlaceMarkerRotation:function(){if(this.placeMarker){var a=this.panorama.getPov();this.pointSymbol.setAngle(a.heading),this.pointGraphics.refresh()}},streetViewFromMapRightClick:function(){var a={mapPoint:this.mapRightClickPoint};this.getStreetView(a,!0)},setMapClickMode:function(a){this.mapClickMode=a}})});
//# sourceMappingURL=StreetView.js.map