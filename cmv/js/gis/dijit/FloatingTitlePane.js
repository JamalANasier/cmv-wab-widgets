/*  ConfigurableMapViewerCMV
 *  version 2.0.0-beta.1
 *  Project: http://cmv.io/
 */

define(["dojo/_base/declare","dijit/TitlePane","dojo/on","dojo/_base/lang","dojo/dnd/Moveable","dojo/aspect","dojo/topic","dojo/sniff","dojo/_base/window","dojo/window","dojo/dom-geometry","dojo/dom-style","dojo/dom-construct","dojo/dom-attr","dojo/dom-class","dojox/layout/ResizeHandle","xstyle/css!dojox/layout/resources/ResizeHandle.css","xstyle/css!./FloatingTitlePane/css/FloatingTitlePane.css"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return a([b],{sidebarPosition:null,canFloat:!1,isFloating:!1,isDragging:!1,dragDelay:3,resizable:!1,resizeOptions:{},isResizing:!1,postCreate:function(){this.canFloat&&(this.createDomNodes(),this.own(c(window,"resize",d.hitch(this,"_endDrag")))),this.own(g.subscribe("titlePane/event",d.hitch(this,"_updateWidgetSidebarPosition"))),this.own(f.after(this,"toggle",d.hitch(this,"_afterToggle"))),this.inherited(arguments)},startup:function(){this.titleBarNode&&this.canFloat&&(this._moveable=new e(this.domNode,{handle:this.titleBarNode,delay:this.dragDelay}),this.dragDelay>0&&(this._moveable.mover.prototype.onMouseUp=function(a){this.destroy(),a.preventDefault(),a.stopPropagation()}),this._titleBarHeight=l.get(this.titleBarNode,"height"),f.after(this._moveable,"onMove",d.hitch(this,"_dragging"),!0),f.after(this._moveable,"onMoveStop",d.hitch(this,"_endDrag"),!0),f.after(this._moveable,"onMoveStart",d.hitch(this,"_startDrag"),!0),c(document,"mouseup, touchend",d.hitch(this,"_endDrag"))),this.inherited(arguments)},createDomNodes:function(){if(this.moveHandleNode=m.create("span",{title:"Move widget",class:"floatingWidgetPopout"},this.titleNode,"after"),this.dockHandleNode=m.create("span",{title:"Dock widget",style:"display:none",class:"floatingWidgetDock"},this.titleNode,"after"),this.own(c(this.dockHandleNode,"click",d.hitch(this,function(a){this._dockWidget(),a.stopImmediatePropagation()}))),this.resizable){var a=d.mixin({targetId:this.id,activeResize:!0,intermediateChanges:!0,startTopic:this.id+"/resize/start",endTopic:this.id+"/resize/end"},this.resizeOptions);this._resizer=new p(a).placeAt(this.id),l.set(this._resizer.resizeHandle,"display","none"),c(this._resizer,"resize",d.hitch(this,"_resizing"),!0),this.own(g.subscribe(this.id+"/resize/start",d.hitch(this,"_startResize"))),this.own(g.subscribe(this.id+"/resize/end",d.hitch(this,"_endResize")))}},toggle:function(){this.isFloating&&this.isDragging||this.resizing||this.inherited(arguments)},_afterToggle:function(){var a=this.open?"open":"close";this._updateTopic(a)},_dragging:function(){if(this.isDragging=!0,this.titleCursor||(this.titleCursor=l.get(this.titleBarNode,"cursor")),l.set(this.titleBarNode,"cursor","move"),!this.isFloating){this._checkSidebarPosition(),l.set(this.dockHandleNode,"display","inline"),l.set(this.moveHandleNode,"display","none"),l.set(this.domNode,"z-index","40");var a=l.getComputedStyle(this.containerNode),b=parseInt(l.getComputedStyle(this.sidebar.containerNode).width,10);k.setContentSize(this.domNode,{w:b-2},a),this.isFloating=!0,this.placeAt(i.body()),l.set(this.domNode,{top:this._moverBox.t-this._titleBarHeight+"px"}),this.resizable&&this._resizer&&this._resizer.resizeHandle&&l.set(this._resizer.resizeHandle,"display","block"),this._updateTopic("undock")}},_startDrag:function(a){this._moverBox=a.marginBox},_endDrag:function(){var a=k.position(this.domNode),b=j.getBox(this.ownerDocument);a.y=Math.min(Math.max(a.y,0),b.h-a.h),a.x=Math.min(Math.max(a.x,0),b.w-a.w),this._relativePosition=a,this._position(),l.set(this.titleBarNode,"cursor",this.titleCursor),window.setTimeout(d.hitch(this,function(){this.isDragging=!1}),50)},_position:function(){if(!o.contains(this.ownerDocumentBody,"dojoMove")){var a=this.domNode,b=j.getBox(this.ownerDocument),c=this._relativePosition,d=c?null:k.position(a),e=Math.floor(b.l+(c?c.x:(b.w-d.w)/2)),f=Math.floor(b.t+(c?c.y:(b.h-d.h)/2));l.set(a,{left:e+"px",top:f+"px"})}},_dockWidget:function(){if(!this.isDragging){n.remove(this.domNode,"style"),l.set(this.dockHandleNode,"display","none"),l.set(this.moveHandleNode,"display","inline");var a=this.sidebar.getChildren();(this.sidebarPosition>a.length||this.sidebarPosition<0)&&(this.sidebarPosition=a.length),this.placeAt(this.sidebar,this.sidebarPosition),this.isFloating=!1,this._updateTopic("dock")}this.resizable&&this._resizer&&this._resizer.resizeHandle&&(l.set(this._resizer.resizeHandle,"display","none"),this._initialDimensions&&g.publish(this.id+"/resize/resize",this._initialDimensions))},_updateWidgetSidebarPosition:function(a){var b=a.widgetID,c=a.sidebarPosition,d=a.action;if(b!==this.id&&this.canFloat&&("dock"===d||"undock"===d))if(this._checkSidebarPosition(),"dock"===d){var e=this.sidebar.getChildren();c<this.sidebarPosition&&this.sidebarPosition<e.length&&this.sidebarPosition++}else"undock"===d&&c<this.sidebarPosition&&this.sidebarPosition>0&&this.sidebarPosition--},_checkSidebarPosition:function(){var a=this.sidebar.getChildren();if(null===this.sidebarPosition){var b=0,c=a.length;for(b=0;b<c;b++){var d=a[b];d.canFloat&&(d.sidebarPosition=b)}}},_resizing:function(a){this.isResizing=!0;var b=this._resizer._getNewCoords(a,this,"margin");b&&g.publish(this.id+"/resize/resize",{h:this._resizeDimensions.h+(b.h-this._resizer.startSize.h),w:this._resizeDimensions.w+(b.w-this._resizer.startSize.w)})},_startResize:function(){this.isResizing=!0,this._resizeDimensions=k.getContentBox(this.containerNode),this._initialDimensions||(this._initialDimensions=this._resizeDimensions)},_endResize:function(){this.isResizing=!1,l.set(this.domNode,"height","auto")},_updateTopic:function(a){g.publish("titlePane/event",{category:"Titlepane Event",action:a,label:this.title,widgetID:this.id,sidebarPosition:this.sidebarPosition,value:a})}})});
//# sourceMappingURL=FloatingTitlePane.js.map